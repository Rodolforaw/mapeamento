<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Timestamps - Controle de Obra</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #e9ecef;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª Teste de Timestamps</h1>
        <p>Este script testa se os timestamps estÃ£o sendo convertidos corretamente para BIGINT.</p>
        
        <button onclick="testTimestampConversion()">Testar ConversÃ£o de Timestamps</button>
        <button onclick="testMarkingCreation()">Testar CriaÃ§Ã£o de MarcaÃ§Ã£o</button>
        <button onclick="clearTestData()">Limpar Dados de Teste</button>
        
        <div id="results"></div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }

        function testTimestampConversion() {
            addResult('ðŸ§ª Testando conversÃ£o de timestamps...', 'info');
            
            // Teste 1: String ISO para nÃºmero
            const isoString = "2025-09-11T09:28:28.741Z";
            const converted = new Date(isoString).getTime();
            addResult(`âœ… String ISO "${isoString}" â†’ ${converted}`, 'success');
            
            // Teste 2: NÃºmero para nÃºmero (deve permanecer igual)
            const number = Date.now();
            const convertedNumber = typeof number === 'string' ? new Date(number).getTime() : number;
            addResult(`âœ… NÃºmero ${number} â†’ ${convertedNumber} (igual: ${number === convertedNumber})`, 'success');
            
            // Teste 3: Verificar se Ã© um nÃºmero vÃ¡lido
            const isValidNumber = typeof converted === 'number' && !isNaN(converted);
            addResult(`âœ… Ã‰ um nÃºmero vÃ¡lido: ${isValidNumber}`, isValidNumber ? 'success' : 'error');
            
            // Teste 4: Verificar se Ã© um timestamp Unix vÃ¡lido
            const isValidTimestamp = converted > 1000000000000 && converted < 2000000000000;
            addResult(`âœ… Ã‰ um timestamp Unix vÃ¡lido: ${isValidTimestamp}`, isValidTimestamp ? 'success' : 'error');
        }

        function testMarkingCreation() {
            addResult('ðŸ§ª Testando criaÃ§Ã£o de marcaÃ§Ã£o...', 'info');
            
            const testMarking = {
                id: 'test_' + Date.now(),
                type: 'marker',
                lat: -23.5505,
                lng: -46.6333,
                coordinates: { lat: -23.5505, lng: -46.6333 },
                properties: {
                    name: 'Teste de Timestamp',
                    description: 'MarcaÃ§Ã£o de teste',
                    source: 'test'
                },
                timestamp: Date.now(),
                lastModified: Date.now()
            };
            
            addResult(`âœ… MarcaÃ§Ã£o de teste criada:`, 'info');
            addResult(`   - ID: ${testMarking.id}`, 'info');
            addResult(`   - Timestamp: ${testMarking.timestamp} (tipo: ${typeof testMarking.timestamp})`, 'info');
            addResult(`   - LastModified: ${testMarking.lastModified} (tipo: ${typeof testMarking.lastModified})`, 'info');
            
            // Simular conversÃ£o como no Supabase
            const convertedMarking = {
                ...testMarking,
                timestamp: typeof testMarking.timestamp === 'string' ? 
                    new Date(testMarking.timestamp).getTime() : 
                    (testMarking.timestamp || Date.now()),
                last_modified: typeof testMarking.lastModified === 'string' ? 
                    new Date(testMarking.lastModified).getTime() : 
                    Date.now()
            };
            
            addResult(`âœ… ApÃ³s conversÃ£o:`, 'info');
            addResult(`   - Timestamp: ${convertedMarking.timestamp} (tipo: ${typeof convertedMarking.timestamp})`, 'info');
            addResult(`   - LastModified: ${convertedMarking.last_modified} (tipo: ${typeof convertedMarking.last_modified})`, 'info');
            
            // Verificar se sÃ£o nÃºmeros vÃ¡lidos
            const timestampValid = typeof convertedMarking.timestamp === 'number' && !isNaN(convertedMarking.timestamp);
            const lastModifiedValid = typeof convertedMarking.last_modified === 'number' && !isNaN(convertedMarking.last_modified);
            
            addResult(`âœ… Timestamp vÃ¡lido: ${timestampValid}`, timestampValid ? 'success' : 'error');
            addResult(`âœ… LastModified vÃ¡lido: ${lastModifiedValid}`, lastModifiedValid ? 'success' : 'error');
        }

        function clearTestData() {
            document.getElementById('results').innerHTML = '';
            addResult('ðŸ§¹ Dados de teste limpos!', 'info');
        }

        // Auto-executar teste ao carregar
        window.addEventListener('load', () => {
            addResult('ðŸ“‹ PÃ¡gina carregada. Clique nos botÃµes para testar.', 'info');
        });
    </script>
</body>
</html>
