<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Mapa em Modo Ruas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .test-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .test-button {
            background: #6d28d9;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #5a21b5;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h3>Teste do Mapa em Modo Ruas</h3>
        <p>Este mapa deve iniciar em modo ruas (padr√£o do Google) em vez de sat√©lite.</p>
        <button class="test-button" onclick="testSatelliteMode()">Alternar para Sat√©lite</button>
        <button class="test-button" onclick="testStreetMode()">Voltar para Ruas</button>
        <button class="test-button" onclick="addTestMarking()">Adicionar Marca√ß√£o de Teste</button>
        <button class="test-button" onclick="loadTestMarkings()">Carregar Marca√ß√µes de Teste</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configura√ß√£o do mapa
        const MARICA_CENTER = [-22.9194, -42.8186];
        const DEFAULT_ZOOM = 13;
        
        let map;
        let drawnItems;
        let streetLayer;
        let satelliteLayer;
        
        // Inicializar mapa
        function initializeMap() {
            map = L.map('map').setView(MARICA_CENTER, DEFAULT_ZOOM);
            
            // Camada de ruas (OpenStreetMap)
            streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            });
            
            // Camada de sat√©lite
            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri',
                maxZoom: 19
            });
            
            // Iniciar em modo ruas (padr√£o do Google)
            streetLayer.addTo(map);
            
            // Inicializar camada para desenhos
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            console.log('Mapa inicializado em modo ruas (padr√£o do Google)');
        }
        
        // Alternar para modo sat√©lite
        function testSatelliteMode() {
            map.removeLayer(streetLayer);
            satelliteLayer.addTo(map);
            console.log('Alternado para modo sat√©lite');
        }
        
        // Voltar para modo ruas
        function testStreetMode() {
            map.removeLayer(satelliteLayer);
            streetLayer.addTo(map);
            console.log('Voltado para modo ruas');
        }
        
        // Adicionar marca√ß√£o de teste
        function addTestMarking() {
            const marker = L.marker(MARICA_CENTER);
            marker.bindPopup(`
                <div style="min-width: 200px;">
                    <h4>üìç Marca√ß√£o de Teste</h4>
                    <p><strong>OS:</strong> TESTE-001</p>
                    <p><strong>Produto:</strong> Meio-fio</p>
                    <p><strong>Medida:</strong> 45 metros</p>
                    <p><strong>Status:</strong> Planejamento</p>
                    <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                </div>
            `);
            drawnItems.addLayer(marker);
            console.log('Marca√ß√£o de teste adicionada');
        }
        
        // Carregar marca√ß√µes de teste do localStorage
        function loadTestMarkings() {
            // Simular marca√ß√µes antigas no localStorage
            const testMarkings = [
                {
                    id: 'test-1',
                    type: 'marker',
                    coordinates: [-22.9194, -42.8186],
                    properties: {
                        name: 'Obra Teste 1',
                        workNumber: 'OS-001',
                        workProduct: 'Tubo de concreto',
                        workMeasure: '300mm',
                        workStatus: 'execu√ß√£o',
                        workDate: '2025-09-20',
                        workObservation: 'Teste de marca√ß√£o antiga'
                    },
                    timestamp: Date.now(),
                    action: 'create'
                },
                {
                    id: 'test-2',
                    type: 'polygon',
                    coordinates: [
                        [-22.9200, -42.8200],
                        [-22.9200, -42.8190],
                        [-22.9190, -42.8190],
                        [-22.9190, -42.8200],
                        [-22.9200, -42.8200]
                    ],
                    properties: {
                        name: '√Årea Teste 2',
                        workNumber: 'OS-002',
                        workProduct: 'Pavimenta√ß√£o',
                        workMeasure: '100m¬≤',
                        workStatus: 'planejamento',
                        workDate: '2025-09-21',
                        workObservation: '√Årea de teste'
                    },
                    timestamp: Date.now(),
                    action: 'create'
                }
            ];
            
            // Salvar no localStorage
            localStorage.setItem('controle_obra_markings', JSON.stringify(testMarkings));
            
            // Carregar marca√ß√µes
            loadOldMarkings();
        }
        
        // Fun√ß√£o para carregar marca√ß√µes antigas (copiada do script principal)
        function loadOldMarkings() {
            try {
                console.log('Carregando marca√ß√µes antigas do localStorage...');
                
                const savedMarkings = localStorage.getItem('controle_obra_markings');
                if (!savedMarkings) {
                    console.log('Nenhuma marca√ß√£o antiga encontrada no localStorage');
                    return;
                }
                
                const markings = JSON.parse(savedMarkings);
                console.log(`Encontradas ${markings.length} marca√ß√µes antigas`);
                
                let loadedCount = 0;
                
                markings.forEach(marking => {
                    if (marking.action !== 'delete' && marking.properties) {
                        try {
                            let work = null;
                            
                            if (marking.type === 'marker' && marking.coordinates && marking.coordinates.length >= 2) {
                                work = L.marker([marking.coordinates[1], marking.coordinates[0]]);
                            } else if (marking.type === 'polygon' && marking.coordinates && marking.coordinates.length > 0) {
                                const latLngs = marking.coordinates.map(coord => [coord[1], coord[0]]);
                                work = L.polygon(latLngs);
                            } else if (marking.type === 'polyline' && marking.coordinates && marking.coordinates.length > 0) {
                                const latLngs = marking.coordinates.map(coord => [coord[1], coord[0]]);
                                work = L.polyline(latLngs);
                            }
                            
                            if (work) {
                                work.workId = marking.id;
                                work.workName = marking.properties.name || 'Obra sem nome';
                                work.workNumber = marking.properties.workNumber || '';
                                work.workProduct = marking.properties.workProduct || '';
                                work.workMeasure = marking.properties.workMeasure || '';
                                work.workObservation = marking.properties.workObservation || '';
                                work.workStatus = marking.properties.workStatus || 'planejamento';
                                work.workDate = marking.properties.workDate || new Date().toISOString().split('T')[0];
                                
                                // Adicionar popup
                                work.bindPopup(`
                                    <div style="min-width: 200px;">
                                        <h4>üìç ${work.workName}</h4>
                                        <p><strong>OS:</strong> ${work.workNumber || 'N√£o informado'}</p>
                                        <p><strong>Produto:</strong> ${work.workProduct || 'N√£o informado'}</p>
                                        <p><strong>Medida:</strong> ${work.workMeasure || 'N√£o informado'}</p>
                                        <p><strong>Status:</strong> ${work.workStatus}</p>
                                        <p><strong>Data:</strong> ${work.workDate}</p>
                                        ${work.workObservation ? `<p><strong>Observa√ß√£o:</strong> ${work.workObservation}</p>` : ''}
                                    </div>
                                `);
                                
                                drawnItems.addLayer(work);
                                loadedCount++;
                            }
                        } catch (error) {
                            console.warn('Erro ao carregar marca√ß√£o antiga:', marking.id, error);
                        }
                    }
                });
                
                console.log(`‚úÖ Carregadas ${loadedCount} marca√ß√µes antigas no mapa`);
                
            } catch (error) {
                console.error('Erro ao carregar marca√ß√µes antigas:', error);
            }
        }
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
        });
    </script>
</body>
</html>
