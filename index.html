<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Obra - Mapa MaricÃ¡</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2196F3">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Controle de Obra">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzIxOTZGMyIvPgo8cGF0aCBkPSJNMTYgOEMxMi42ODYzIDggMTAgMTAuNjg2MyAxMCAxNEMxMCAxNy4zMTM3IDEyLjY4NjMgMjAgMTYgMjBDMTkuMzEzNyAyMCAyMiAxNy4zMTM3IDIyIDE0QzIyIDEwLjY4NjMgMTkuMzEzNyA4IDE2IDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="map"></div>
    
    <!-- Control Panel -->
    <div class="container">
        <!-- Header com status de sincronizaÃ§Ã£o -->
        <div class="header">
            <h1>ğŸ—ï¸ Controle de Obra - MaricÃ¡</h1>
            <div class="header-controls">
                <div id="sync-status" class="sync-status" title="Status de sincronizaÃ§Ã£o">
                    <div class="sync-dot"></div>
                    <span class="sync-text">Sincronizado</span>
                </div>
                <button id="menu-toggle" class="menu-toggle" aria-label="Abrir menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
        
        <!-- Overlay para fechar menu em mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <!-- Painel lateral -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ—ï¸ Controle de Obra</h2>
                <p>MaricÃ¡ - RJ</p>
                <button class="sidebar-close" id="sidebar-close" aria-label="Fechar menu">Ã—</button>
            </div>
            
            <div class="control-group">
            <button id="satellite-toggle" class="control-btn">
                <span class="icon">ğŸ›°ï¸</span>
                SatÃ©lite
            </button>
            
            <button id="export-kmz" class="control-btn">
                <span class="icon">ğŸ“</span>
                Exportar KMZ
            </button>
            
            <button id="export-excel" class="control-btn">
                <span class="icon">ğŸ“Š</span>
                Exportar Excel
            </button>
            
            <label for="import-kmz" class="control-btn">
                <span class="icon">ğŸ“‚</span>
                Importar KMZ
                <input type="file" id="import-kmz" accept=".kmz,.kml" multiple style="display: none;">
            </label>
            
            <button id="manage-works" class="control-btn" title="Gerenciar obras">
                <span class="icon">ğŸ“Š</span>
                Gerenciar Obras
            </button>
            
            <button id="sync-offline" class="control-btn sync-btn" style="display: none;">
                <span class="icon">ğŸ”„</span>
                Sincronizar
            </button>
            
            <button id="clear-data" class="control-btn danger-btn">
                <span class="icon">ğŸ—‘ï¸</span>
                Limpar Dados
            </button>
            
            <button id="location-toggle" class="control-btn" title="Ativar rastreamento de localizaÃ§Ã£o">
                ğŸ“ Minha LocalizaÃ§Ã£o
            </button>
            
            <button id="devices-toggle" class="control-btn" title="Mostrar localizaÃ§Ãµes dos dispositivos">
                ğŸ“± Dispositivos Online
            </button>
            
            <!-- BotÃµes de sincronizaÃ§Ã£o especÃ­ficos por modo -->
            <button id="manual-sync-pc" class="control-btn sync-btn" title="Sincronizar manualmente (modo PC)">
                ğŸ”„ Sincronizar Agora
            </button>
            
            <button id="force-sync-test" class="control-btn sync-btn" title="ForÃ§ar sincronizaÃ§Ã£o imediata para teste">
                âš¡ SincronizaÃ§Ã£o ForÃ§ada
            </button>
            
            <button id="debug-markings" class="control-btn" title="Debug das marcaÃ§Ãµes locais">
                ğŸ” Debug MarcaÃ§Ãµes
            </button>
            
            <button id="clear-old-markings" class="control-btn" title="Limpar marcaÃ§Ãµes antigas para teste">
                ğŸ—‘ï¸ Limpar Antigas
            </button>
            
            <button id="debug-supabase" class="control-btn" title="Debug dos dados do Supabase">
                ğŸ” Debug Supabase
            </button>
            
            <button id="test-circle" class="control-btn" title="Criar cÃ­rculo de teste com raio 500">
                ğŸ§ª Teste CÃ­rculo
            </button>
            
            <button id="test-all-shapes" class="control-btn" title="Criar todas as formas de teste">
                ğŸ§ª Teste Todas as Formas
            </button>
            
            <button id="clear-all-reload" class="control-btn" title="Limpar tudo e recarregar apenas com dados preservados">
                ğŸ—‘ï¸ Limpar Tudo e Recarregar
            </button>
            
            <button id="migrate-old-markings" class="control-btn" title="Migrar marcaÃ§Ãµes antigas do Supabase para formato com dados preservados">
                ğŸ”„ Migrar MarcaÃ§Ãµes Antigas
            </button>
            
            <button id="download-offline-pwa" class="control-btn offline-btn" style="display: none;" title="Baixar dados para trabalho offline">
                ğŸ“¥ Baixar Dados
            </button>
            
            <button id="upload-offline-pwa" class="control-btn offline-btn" style="display: none;" title="Enviar dados quando online">
                ğŸ“¤ Enviar Dados
            </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Carregando mapa...</p>
    </div>
    
    <!-- Status de SincronizaÃ§Ã£o -->
    <div id="sync-status" class="sync-status" style="display: none;">
        <span id="sync-status-text">Sincronizando...</span>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <!-- JSZip para manipulaÃ§Ã£o de arquivos ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <!-- SheetJS para exportaÃ§Ã£o Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script src="app.js"></script>

</div>

    <!-- Modal de Gerenciamento de Obras -->
    <div id="works-modal" class="modal">
        <div class="modal-content works-modal-content">
            <div class="modal-header">
                <h3>ğŸ“Š Gerenciamento de Obras</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="works-summary">
                    <div class="summary-card">
                        <h4>ğŸ“ˆ Resumo</h4>
                        <p><strong>Total de Obras:</strong> <span id="total-works">0</span></p>
                        <p><strong>Total de MarcaÃ§Ãµes:</strong> <span id="total-markings">0</span></p>
                    </div>
                </div>
                
                <div class="works-filters">
                    <input type="text" id="search-works" placeholder="ğŸ” Buscar por nÃºmero da O.S..." class="search-input">
                    <button id="refresh-works" class="filter-btn">ğŸ”„ Atualizar</button>
                </div>
                
                <div class="works-table-container">
                    <table id="works-table" class="works-table">
                        <thead>
                            <tr>
                                <th>NÃºmero da O.S.</th>
                                <th>Produto</th>
                                <th>MarcaÃ§Ãµes</th>
                                <th>Ãšltima AtualizaÃ§Ã£o</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="works-table-body">
                            <!-- Dados serÃ£o inseridos dinamicamente -->
                        </tbody>
                    </table>
                </div>
                
                <div class="imported-markings-section">
                    <h4>ğŸ“ MarcaÃ§Ãµes Importadas (KMZ)</h4>
                    <div class="imported-summary">
                        <p><strong>Total de Arquivos Importados:</strong> <span id="total-imported-files">0</span></p>
                        <p><strong>Total de MarcaÃ§Ãµes Importadas:</strong> <span id="total-imported-markings">0</span></p>
                    </div>
                    
                    <div class="imported-table-container">
                        <table id="imported-table" class="works-table">
                            <thead>
                                <tr>
                                    <th>Nome do Arquivo</th>
                                    <th>MarcaÃ§Ãµes</th>
                                    <th>Data de ImportaÃ§Ã£o</th>
                                    <th>AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody id="imported-table-body">
                                <!-- Dados serÃ£o inseridos dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="works-actions">
                    <button id="export-all-works" class="action-btn primary">
                        ğŸ“¦ Exportar Todas as Obras
                    </button>
                    <button id="clear-all-works" class="action-btn danger">
                        ğŸ—‘ï¸ Limpar Todas as Obras
                    </button>
                    <button id="clear-imported-markings" class="action-btn danger">
                        ğŸ—‘ï¸ Limpar Todas as ImportaÃ§Ãµes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para informaÃ§Ãµes da marcaÃ§Ã£o -->
    <div id="marking-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>InformaÃ§Ãµes da MarcaÃ§Ã£o</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="marking-form">
                    <div class="form-group">
                        <label for="os-number">NÃºmero da O.S:</label>
                        <input type="text" id="os-number" name="osNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="product">Produto:</label>
                        <input type="text" id="product" name="product" required>
                    </div>
                    <div class="form-group">
                        <label for="measurement">Metragem:</label>
                        <input type="number" id="measurement" name="measurement" step="0.01" required>
                        <select id="measurement-unit" name="measurementUnit">
                            <option value="m">metros (m)</option>
                            <option value="mÂ²">metrosÂ² (mÂ²)</option>
                            <option value="km">quilÃ´metros (km)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">DescriÃ§Ã£o:</label>
                        <textarea id="description" name="description" rows="3" placeholder="DescriÃ§Ã£o detalhada da marcaÃ§Ã£o..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancel-marking" class="btn-secondary">Cancelar</button>
                        <button type="submit" class="btn-primary">Salvar MarcaÃ§Ã£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
