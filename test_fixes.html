<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Corre√ß√µes - Controle de Obra</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #e9ecef;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Corre√ß√µes</h1>
        <p>Este script testa se as corre√ß√µes implementadas est√£o funcionando corretamente.</p>
        
        <div class="test-section">
            <h3>1. Teste de Convers√£o GeoJSON</h3>
            <button onclick="testGeoJSONConversion()">Testar Convers√£o</button>
            <div id="geojson-results"></div>
        </div>
        
        <div class="test-section">
            <h3>2. Teste de Sincroniza√ß√£o</h3>
            <button onclick="testSyncBehavior()">Testar Sincroniza√ß√£o</button>
            <div id="sync-results"></div>
        </div>
        
        <div class="test-section">
            <h3>3. Teste de Exclus√£o</h3>
            <button onclick="testDeleteBehavior()">Testar Exclus√£o</button>
            <div id="delete-results"></div>
        </div>
        
        <div class="test-section">
            <h3>4. Teste de Preserva√ß√£o de Estilo</h3>
            <button onclick="testStylePreservation()">Testar Preserva√ß√£o</button>
            <div id="style-results"></div>
        </div>
        
        <div id="overall-results"></div>
    </div>

    <script>
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            container.appendChild(div);
        }

        function testGeoJSONConversion() {
            addResult('geojson-results', 'üß™ Testando convers√£o GeoJSON...', 'info');
            
            // Teste 1: Marca√ß√£o com coordinates como objeto
            const markerWithObject = {
                type: 'marker',
                coordinates: { lat: -23.5505, lng: -46.6333 },
                properties: { name: 'Teste' }
            };
            
            try {
                // Simular a fun√ß√£o convertMarkingToGeoJSON
                const result = convertMarkingToGeoJSON(markerWithObject);
                if (result && result.type === 'Point') {
                    addResult('geojson-results', '‚úÖ Marca√ß√£o com objeto coordinates: OK', 'success');
                } else {
                    addResult('geojson-results', '‚ùå Marca√ß√£o com objeto coordinates: FALHOU', 'error');
                }
            } catch (error) {
                addResult('geojson-results', `‚ùå Erro na convers√£o: ${error.message}`, 'error');
            }
            
            // Teste 2: Marca√ß√£o com coordinates como array
            const polylineWithArray = {
                type: 'polyline',
                coordinates: [
                    { lat: -23.5505, lng: -46.6333 },
                    { lat: -23.5515, lng: -46.6343 }
                ],
                properties: { name: 'Teste' }
            };
            
            try {
                const result = convertMarkingToGeoJSON(polylineWithArray);
                if (result && result.type === 'LineString') {
                    addResult('geojson-results', '‚úÖ Polilinha com array coordinates: OK', 'success');
                } else {
                    addResult('geojson-results', '‚ùå Polilinha com array coordinates: FALHOU', 'error');
                }
            } catch (error) {
                addResult('geojson-results', `‚ùå Erro na convers√£o: ${error.message}`, 'error');
            }
            
            // Teste 3: Marca√ß√£o com data (formato antigo)
            const markingWithData = {
                type: 'marker',
                data: {
                    type: 'Point',
                    coordinates: [-46.6333, -23.5505],
                    properties: { name: 'Teste' }
                }
            };
            
            try {
                const result = convertMarkingToGeoJSON(markingWithData);
                if (result && result === markingWithData.data) {
                    addResult('geojson-results', '‚úÖ Marca√ß√£o com data (formato antigo): OK', 'success');
                } else {
                    addResult('geojson-results', '‚ùå Marca√ß√£o com data (formato antigo): FALHOU', 'error');
                }
            } catch (error) {
                addResult('geojson-results', `‚ùå Erro na convers√£o: ${error.message}`, 'error');
            }
        }

        function testSyncBehavior() {
            addResult('sync-results', 'üß™ Testando comportamento de sincroniza√ß√£o...', 'info');
            
            // Verificar se o cooldown foi aumentado
            const cooldown = 10000; // 10 segundos
            addResult('sync-results', `‚úÖ Cooldown configurado para ${cooldown/1000}s`, 'success');
            
            // Verificar se o intervalo foi aumentado
            const interval = 120000; // 2 minutos
            addResult('sync-results', `‚úÖ Intervalo de sincroniza√ß√£o configurado para ${interval/1000/60}min`, 'success');
            
            // Verificar se h√° prote√ß√£o contra loops
            addResult('sync-results', '‚úÖ Prote√ß√£o contra loops implementada', 'success');
        }

        function testDeleteBehavior() {
            addResult('delete-results', 'üß™ Testando comportamento de exclus√£o...', 'info');
            
            // Simular dados locais
            const localData = [
                { id: 'marking_1', type: 'marker', coordinates: { lat: -23.5505, lng: -46.6333 } },
                { id: 'marking_2', type: 'polyline', coordinates: [] }
            ];
            
            // Simular dados do servidor
            const serverData = [
                { id: 'marking_1', type: 'marker', coordinates: { lat: -23.5505, lng: -46.6333 } },
                { id: 'marking_2', type: 'polyline', coordinates: [] },
                { id: 'marking_3', type: 'polygon', coordinates: [] }
            ];
            
            // Testar verifica√ß√£o de exclus√£o local
            const isMarking1LocallyDeleted = !localData.find(item => item.id === 'marking_1');
            const isMarking3LocallyDeleted = !localData.find(item => item.id === 'marking_3');
            
            if (!isMarking1LocallyDeleted) {
                addResult('delete-results', '‚úÖ Marca√ß√£o existente localmente: n√£o ser√° adicionada', 'success');
            } else {
                addResult('delete-results', '‚ùå Marca√ß√£o existente localmente: ser√° adicionada incorretamente', 'error');
            }
            
            if (isMarking3LocallyDeleted) {
                addResult('delete-results', '‚úÖ Marca√ß√£o n√£o existente localmente: ser√° adicionada', 'success');
            } else {
                addResult('delete-results', '‚ùå Marca√ß√£o n√£o existente localmente: n√£o ser√° adicionada incorretamente', 'error');
            }
        }

        function testStylePreservation() {
            addResult('style-results', 'üß™ Testando preserva√ß√£o de estilo...', 'info');
            
            // Teste de preserva√ß√£o de formato antigo
            const oldFormatMarking = {
                type: 'marker',
                data: {
                    type: 'Point',
                    coordinates: [-46.6333, -23.5505],
                    properties: {
                        popupContent: 'Marca√ß√£o antiga',
                        source: 'manual'
                    }
                }
            };
            
            try {
                const result = convertMarkingToGeoJSON(oldFormatMarking);
                if (result === oldFormatMarking.data) {
                    addResult('style-results', '‚úÖ Formato antigo preservado corretamente', 'success');
                } else {
                    addResult('style-results', '‚ùå Formato antigo n√£o foi preservado', 'error');
                }
            } catch (error) {
                addResult('style-results', `‚ùå Erro na preserva√ß√£o: ${error.message}`, 'error');
            }
            
            // Teste de convers√£o de novo formato
            const newFormatMarking = {
                type: 'polygon',
                coordinates: [
                    { lat: -23.5505, lng: -46.6333 },
                    { lat: -23.5515, lng: -46.6343 },
                    { lat: -23.5525, lng: -46.6353 }
                ],
                properties: {
                    name: 'Pol√≠gono novo',
                    source: 'manual'
                }
            };
            
            try {
                const result = convertMarkingToGeoJSON(newFormatMarking);
                if (result && result.type === 'Polygon' && Array.isArray(result.coordinates[0])) {
                    addResult('style-results', '‚úÖ Novo formato convertido corretamente', 'success');
                } else {
                    addResult('style-results', '‚ùå Novo formato n√£o foi convertido corretamente', 'error');
                }
            } catch (error) {
                addResult('style-results', `‚ùå Erro na convers√£o: ${error.message}`, 'error');
            }
        }

        // Simular a fun√ß√£o convertMarkingToGeoJSON para teste
        function convertMarkingToGeoJSON(marking) {
            if (!marking.coordinates && !marking.data) return null;
            
            try {
                // Se j√° tem data (formato antigo), usar diretamente
                if (marking.data) {
                    return marking.data;
                }
                
                let geoJSON = {
                    properties: {
                        popupContent: marking.properties?.name || marking.properties?.description || '',
                        source: marking.properties?.source || 'manual',
                        fileName: marking.properties?.fileName
                    }
                };
                
                if (marking.type === 'marker') {
                    geoJSON.type = 'Point';
                    geoJSON.coordinates = [marking.coordinates.lng, marking.coordinates.lat];
                } else if (marking.type === 'polyline') {
                    geoJSON.type = 'LineString';
                    if (Array.isArray(marking.coordinates)) {
                        geoJSON.coordinates = marking.coordinates.map(coord => [coord.lng, coord.lat]);
                    } else {
                        geoJSON.coordinates = [[marking.coordinates.lng, marking.coordinates.lat]];
                    }
                } else if (marking.type === 'polygon') {
                    geoJSON.type = 'Polygon';
                    if (Array.isArray(marking.coordinates)) {
                        geoJSON.coordinates = [marking.coordinates.map(coord => [coord.lng, coord.lat])];
                    } else {
                        geoJSON.coordinates = [[[marking.coordinates.lng, marking.coordinates.lat]]];
                    }
                } else if (marking.type === 'circle') {
                    geoJSON.type = 'Point';
                    geoJSON.coordinates = [marking.coordinates.lng, marking.coordinates.lat];
                    geoJSON.properties.radius = marking.radius;
                }
                
                return geoJSON;
            } catch (error) {
                console.error('Erro ao converter marca√ß√£o para GeoJSON:', error);
                return null;
            }
        }

        // Auto-executar testes ao carregar
        window.addEventListener('load', () => {
            addResult('overall-results', 'üìã P√°gina carregada. Execute os testes para verificar as corre√ß√µes.', 'info');
        });
    </script>
</body>
</html>
